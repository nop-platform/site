# 分布式任务调度

## 名词解释
- **流程定义**：通过拖拽任务节点并建立任务节点的关联所形成的可视化DAG

- **流程实例**：流程实例是流程定义的实例化，可以通过手动启动或定时调度生成。每运行一次流程定义，产生一个流程实例

- **任务实例**：任务实例是流程定义中任务节点的实例化，标识着某个具体的任务

- **任务类型**：目前支持有 SHELL、SQL、SUB_PROCESS(子流程)、PROCEDURE、MR、SPARK、PYTHON、DEPENDENT(依赖)，同时计划支持动态插件扩展，注意：其中 SUB_PROCESS类型的任务需要关联另外一个流程定义，被关联的流程定义是可以单独启动执行的

- **调度方式**：系统支持基于 cron 表达式的定时调度和手动调度。命令类型支持：启动工作流、从当前节点开始执行、恢复被容错的工作流、恢复暂停流程、从失败节点开始执行、补数、定时、重跑、暂停、停止、恢复等待线程。 其中 恢复被容错的工作流 和 恢复等待线程 两种命令类型是由调度内部控制使用，外部无法调用

- **定时调度**：系统支持cron表达式可视化的生成

- **依赖**：系统不单单支持 DAG 简单的前驱和后继节点之间的依赖，同时还提供任务依赖节点，支持流程间的自定义任务依赖

- **优先级** ：支持流程实例和任务实例的优先级，如果流程实例和任务实例的优先级不设置，则默认是先进先出

- **邮件告警**：支持 SQL任务 查询结果邮件发送，流程实例运行结果邮件告警及容错告警通知

- **失败策略**：对于并行运行的任务，如果有任务失败，提供两种失败策略处理方式，继续是指不管并行运行任务的状态，直到流程失败结束。结束是指一旦发现失败任务，则同时Kill掉正在运行的并行任务，流程失败结束

- **补数**：补历史数据，支持区间并行和串行两种补数方式，其日期选择方式包括日期范围和日期枚举两种

## 执行策略

* 并行：如果对于同一个工作流定义，同时有多个工作流实例，则并行执行工作流实例。

* 串行等待：如果对于同一个工作流定义，同时有多个工作流实例，则串行执行工作流实例。

* 串行抛弃：如果对于同一个工作流定义，同时有多个工作流实例，则抛弃后生成的工作流实例并杀掉正在跑的实例。

* 串行优先：如果对于同一个工作流定义，同时有多个工作流实例，则按照优先级串行执行工作流实例。


## 工作流参数

工作流运行参数说明：

* 失败策略：当某一个任务节点执行失败时，其他并行的任务节点需要执行的策略。”继续“表示：某一任务失败后，其他任务节点正常执行；”结束“表示：终止所有正在执行的任务，并终止整个流程。

* 通知策略：当流程结束，根据流程状态发送流程执行信息通知邮件，包含任何状态都不发，成功发，失败发，成功或失败都发。

* 流程优先级：流程运行的优先级，分五个等级：最高（HIGHEST），高(HIGH),中（MEDIUM）,低（LOW），最低（LOWEST）。当 master 线程数不足时，级别高的流程在执行队列中会优先执行，相同优先级的流程按照先进先出的顺序执行。

* Worker 分组：该流程只能在指定的 worker 机器组里执行。默认是 Default，可以在任一 worker 上执行。

* 通知组：选择通知策略||超时报警||发生容错时，会发送流程信息或邮件到通知组里的所有成员。

* 启动参数: 在启动新的流程实例时，设置或覆盖全局参数的值。

* 补数：指运行指定日期范围内的工作流定义，根据补数策略生成对应的工作流实例，补数策略包括串行补数、并行补数 2 种模式。
       日期可以通过页面选择或者手动输入，日期范围是左关右关区间(startDate <= N <= endDate)
       串行补数：指定时间范围内，从开始日期至结束日期依次执行补数，依次生成多条流程实例；点击运行工作流，选择串行补数模式：例如从7月 9号到7月10号依次执行，依次在流程实例页面生成两条流程实例。
  并行度：是指在并行补数的模式下，最多并行执行的实例数。

## MasterServer

MasterServer主要负责 DAG 任务切分、任务提交监控，并同时监听其它MasterServer和WorkerServer的健康状态。

MasterServer内部实现功能：

1. JobScheduler定时触发任务
2. JobWorkflowRunner负责DAG任务切分、任务提交监控

## WorkerServer

WorkerServer主要负责任务的执行和提供日志服务。

1. JobTaskBizModel提供任务的启动、停止、查看任务状态的功能
2. LoggerBizModel提供日志分片查看、刷新和下载等功能

## 补数逻辑

1. 串行补数：指定时间范围内，从开始日期至结束日期依次执行补数，只生成一条流程实例；
2. 并行补数：指定时间范围内，多天同时进行补数，生成N条流程实例
